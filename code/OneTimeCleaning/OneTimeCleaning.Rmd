---
title: "MiscCleaning"
---

Downloading libraries
```{r}
library(tidyverse)
library(readxl)
library(janitor)
```


Cleaning the COVI database, and getting important results from each state and year
```{r}

```

Not much cleaning necessary, but reading in the state unemployment data and 
making it longer and only taking data from 2002 onwards
```{r}
state_unemployment <- read_excel("../data/staadata.xlsx", skip = 6) %>%
  slice(-1) %>%
  rename(State = ...2, year = ...3, unemployment = rate) %>%
  filter(year >= 2000) %>%
  arrange(State, year) %>%
  group_by(State) %>%
  mutate(unemployment_prev = lag(unemployment, 1), 
         year = as.numeric(year)) %>%
  ungroup() %>%
  filter(!is.na(unemployment_prev)) %>%
  mutate(change_unemployment = unemployment - unemployment_prev) %>%
  select(c("State", "year", "unemployment", "change_unemployment"))

write.csv(state_unemployment, "../cleaned_data/unemployment.csv")
```




This gets data for District-Level PVI, and combines it with state-level PVI
Notes on what PVI district data is used for what election:
2024: 2023 data
2022: 2023 data
2020: 2019 data, but NC changed their borders b4 the 2020 election and there's no data on that (replace with NA?)
2018: 2019 data
2016: 2015 data, but problems with Florida, NC, and VA (replace with NA?)
2014: 2015 data
2012: 2012 data
2010: 2009 data
2008: 2007 data
2006: 2007 data
2004: 2003
2002: 2003
```{r}
PVI_path <- "../data/PVI.xlsx"

#Getting PVI data, which is kept in different excel sheets
PVI_list <- PVI_path %>%
  excel_sheets() %>%
  map(~ read_excel(PVI_path, sheet = .)) %>%
  magrittr::extract(2:length(.)) #First excel sheet is an explanation

#For some reason, Cook changed District to Number in the final dataset
PVI_list[[15]]$District <- PVI_list[[15]]$Number

PVI_district <- Reduce(function(x, y) full_join(x, y, by=c("State","District")), PVI_list) %>%
#Replacing D+12 with 12, R+12 with -12, and EVEN with 0
mutate(across(contains("Cook"), ~case_when(
  grepl("D", .) ~ gsub("D\\+", "", .),
  grepl("R", .) ~ gsub("R\\+","-", .),
  grepl("EVEN", .) ~ "0",
  TRUE ~ NA_character_
 ))) %>%
  mutate(across(contains("Cook"), as.numeric)) %>%
  #Pivoting dataset to make it look like it should
  select(c("State", "District") | contains("Raw Cook PVI")) %>%
  pivot_longer(contains("Cook"), names_to = "Year", values_to = "Raw_PVI") %>%
  mutate(District = str_remove(District, "\\.0"),
         Year = as.numeric(str_remove(Year, " Raw Cook PVI"))) %>%
  #Using previously-explained years to get the exact data/year combos I want
  filter(Year %in% c(2003, 2007, 2009, 2012, 2015, 2019, 2023)) %>%
  rowwise() %>%
  mutate(True_Year = list(case_when(
    Year == 2023 ~ c(2022, 2024),
    Year == 2019 ~ c(2018, 2020), 
    Year == 2015 ~ c(2014, 2016), 
    Year == 2012 ~ 2012, 
    Year == 2009 ~ 2010, 
    Year == 2007 ~ c(2006, 2008), 
    Year == 2003 ~ c(2002, 2004), 
    TRUE ~ Year
  )), .after = Year) %>%
  unnest(True_Year) %>%
  unique() %>%
  filter(!(
    (Year == 2020 & State == "North Carolina") |
    (Year == 2016 & State %in% c("North Carolina", "Florida", "Virginia"))
  )) %>%
  select(-c("Year"))
  

total_president_margin <- read.csv("../data/HistoricalElections/President Summary - Sheet1.csv")

PVI_state <- cleaned_pres %>%
  group_by(state_po) %>%
  mutate(lagged_state_margin = lag(margin, order_by = state_po)) %>%
  filter(year >= 2000) %>%
  full_join(total_president_margin, by = c("year" = "year")) %>%
  rename(state_margin = margin) %>%
  select(-c("DEMOCRAT", "REPUBLICAN")) %>%
  mutate(Raw_PVI = 0.5*(0.75*(state_margin - national_margin) + 
           0.25 * (lagged_state_margin - lagged_national_margin))) %>%
  select(c("year", "state_po", "Raw_PVI")) %>%
  rowwise() %>%
  mutate(True_Year = list(c(year + 2, year + 4)), .after = year, 
         district = "0") %>%
  unnest(True_Year) %>%
  select(-c("year")) %>%
  rename(Abbreviation = state_po, 
         District = district)

states_list <- read.csv("../cleaned_data/StatesList.csv")


PVI_full <- PVI_district %>%
  full_join(states_list, by = c("State" = "State")) %>%
  select("Abbreviation", "District", "True_Year", "Raw_PVI") %>%
  bind_rows(PVI_state)

write.csv(PVI_full, "../cleaned_data/Completed_PVI.csv")
```


